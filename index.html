<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CD Collection</title>
    
    <link rel="icon" href="/cd-collection/favicon.ico" sizes="any">
    <meta name="theme-color" content="#111827"> 
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        body {
            background-color: #111827; /* bg-gray-900 */
        }
        .dragging {
            opacity: 0.5;
        }

        /* --- Custom Styles for the Barcode Scanner --- */
        .scanner-viewfinder {
            position: relative;
            width: 300px;
            height: 225px; /* 4:3 aspect ratio */
            overflow: hidden;
            border-radius: 0.5rem; /* rounded-lg */
            border: 2px dashed #4b5563; /* border-gray-600 */
        }

        .scanner-viewfinder #reader {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .scanner-scan-line {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, #818cf8, transparent);
            box-shadow: 0 0 10px #818cf8;
            animation: scan 2.5s infinite ease-in-out;
            border-radius: 9999px;
        }

        @keyframes scan {
            0% { transform: translateY(5px); }
            50% { transform: translateY(calc(225px - 8px)); }
            100% { transform: translateY(5px); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            where, 
            getDocs,
            doc,
            updateDoc,
            writeBatch,
            deleteDoc
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBoo2YQkIy0jMw8IalLJ8PrI-YAQMYP8B8",
            authDomain: "cd-collection-bb9a9.firebaseapp.com",
            projectId: "cd-collection-bb9a9",
            storageBucket: "cd-collection-bb9a9.firebasestorage.app",
            messagingSenderId: "687978567961",
            appId: "1:687978567961:web:9f26cc777aaf5e43228d88"
        };

        // --- Discogs API Configuration ---
        // IMPORTANT: PASTE YOUR DISCOGS PERSONAL ACCESS TOKEN HERE
        const DISCOGS_TOKEN = "wGihEmsgoVbrFZvpHBMIjcZUIoynMvcxeZpsXYNv";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Helper Functions ---
        const sanitizeBarcode = (barcode) => {
            return barcode.replace(/[-\s]/g, '');
        };

        // --- UI Components ---
        function ConfirmationModal({ isOpen, message, onConfirm, onCancel }) {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
                    <div className="bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full">
                        <p className="text-white mb-4">{message}</p>
                        <div className="flex justify-end gap-4">
                            <button onClick={onCancel} className="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-500">Cancel</button>
                            <button onClick={onConfirm} className="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Confirm</button>
                        </div>
                    </div>
                </div>
            );
        }

        // --- Main App Component ---
        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    setUser(user);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            if (loading) {
                return <div className="flex items-center justify-center h-screen bg-gray-900 text-white">Loading...</div>;
            }

            return (
                <div className="min-h-screen bg-gray-900 text-gray-100 font-sans">
                    {user ? <Dashboard user={user} /> : <Login />}
                </div>
            );
        }

        // --- Login/Signup Component ---
        function Login() {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [isSignUp, setIsSignUp] = useState(false);

            const handleAuth = async (e) => {
                e.preventDefault();
                setError('');
                try {
                    if (isSignUp) {
                        await createUserWithEmailAndPassword(auth, email, password);
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                    }
                } catch (err) {
                    setError(err.message);
                }
            };

            return (
                <div className="flex items-center justify-center h-screen">
                    <div className="w-full max-w-md p-8 space-y-6 bg-gray-800 rounded-lg shadow-lg">
                        <h2 className="text-2xl font-bold text-center text-white">{isSignUp ? 'Create Account' : 'Welcome Back'}</h2>
                        <form onSubmit={handleAuth} className="space-y-6">
                            <div>
                                <label className="text-sm font-bold text-gray-400">Email</label>
                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="w-full p-3 mt-1 text-gray-200 bg-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                    required
                                />
                            </div>
                            <div>
                                <label className="text-sm font-bold text-gray-400">Password</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full p-3 mt-1 text-gray-200 bg-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                    required
                                />
                            </div>
                            {error && <p className="text-sm text-red-400">{error}</p>}
                            <button type="submit" className="w-full py-3 font-bold text-white bg-indigo-600 rounded-md hover:bg-indigo-700 transition duration-300">
                                {isSignUp ? 'Sign Up' : 'Login'}
                            </button>
                        </form>
                        <p className="text-sm text-center text-gray-400">
                            {isSignUp ? 'Already have an account?' : "Don't have an account?"}
                            <button onClick={() => setIsSignUp(!isSignUp)} className="ml-1 font-bold text-indigo-400 hover:underline">
                                {isSignUp ? 'Login' : 'Sign Up'}
                            </button>
                        </p>
                    </div>
                </div>
            );
        }

        // --- Main Dashboard Component ---
        function Dashboard({ user }) {
            const [view, setView] = useState('gallery');
            const [albums, setAlbums] = useState([]);
            const [loadingAlbums, setLoadingAlbums] = useState(true);

            const fetchAlbums = useCallback(async () => {
                if (!user) return;
                setLoadingAlbums(true);
                try {
                    const q = query(collection(db, "albums"), where("userId", "==", user.uid));
                    const querySnapshot = await getDocs(q);
                    const userAlbums = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    userAlbums.sort((a, b) => {
                        const artistA = a.artist.toLowerCase();
                        const artistB = b.artist.toLowerCase();
                        if (artistA < artistB) return -1;
                        if (artistA > artistB) return 1;
                        return a.title.toLowerCase().localeCompare(b.title.toLowerCase());
                    });

                    setAlbums(userAlbums);
                } catch (error) {
                    console.error("Error fetching albums:", error);
                } finally {
                    setLoadingAlbums(false);
                }
            }, [user]);

            useEffect(() => {
                fetchAlbums();
            }, [fetchAlbums]);

            const handleAlbumsChanged = () => {
                fetchAlbums();
                setView('gallery');
            };

            return (
                <div className="p-4 md:p-8">
                    <Navbar user={user} setView={setView} currentView={view} />
                    <main className="mt-8">
                        {view === 'add' && <AddAlbum onAlbumAdded={handleAlbumsChanged} onCancel={() => setView('gallery')} />}
                        {view === 'stats' && <Stats albums={albums} loading={loadingAlbums} />}
                        {view === 'gallery' && <AlbumDisplay albums={albums} setAlbums={setAlbums} loading={loadingAlbums} onAlbumUpdated={fetchAlbums} setView={setView} />}
                        {view === 'search' && <Search albums={albums} onCancel={() => setView('gallery')} />}
                    </main>
                </div>
            );
        }

        // --- Navbar Component ---
        function Navbar({ user, setView, currentView }) {
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const activeClass = "bg-indigo-600 text-white";
            const inactiveClass = "text-gray-300 hover:bg-gray-700 hover:text-white";

            const NavLink = ({ view, children }) => (
                <button 
                    onClick={() => { setView(view); setIsMenuOpen(false); }} 
                    className={`w-full text-left px-3 py-2 rounded-md text-sm font-medium ${currentView === view ? activeClass : inactiveClass}`}
                >
                    {children}
                </button>
            );

            return (
                <header className="relative">
                    <div className="flex justify-between items-center">
                        <div className="flex items-baseline gap-2">
                            <h1 className="text-3xl font-bold text-white">CD Collection</h1>
                            <span className="font-mono text-xs text-gray-500">v0.10</span>
                        </div>

                        {/* Hamburger Button - Mobile */}
                        <div className="md:hidden">
                            <button onClick={() => setIsMenuOpen(!isMenuOpen)} className="p-2 rounded-md text-gray-400 hover:text-white hover:bg-gray-700">
                                <svg className="h-6 w-6" stroke="currentColor" fill="none" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d={isMenuOpen ? "M6 18L18 6M6 6l12 12" : "M4 6h16M4 12h16M4 18h16"} />
                                </svg>
                            </button>
                        </div>

                        {/* Desktop Navigation */}
                        <nav className="hidden md:flex items-center space-x-2 bg-gray-800 p-2 rounded-lg">
                            <NavLink view="gallery">Collection</NavLink>
                            <NavLink view="stats">Stats</NavLink>
                            <NavLink view="add">+ Add Album</NavLink>
                        </nav>
                        <div className="hidden md:flex items-center space-x-4">
                            <span className="text-sm text-gray-400">{user.email}</span>
                            <button onClick={() => signOut(auth)} className="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">Logout</button>
                        </div>
                    </div>

                    {/* Mobile Menu */}
                    {isMenuOpen && (
                        <div className="md:hidden mt-4 bg-gray-800 rounded-lg p-4">
                            <nav className="flex flex-col space-y-2">
                                <NavLink view="gallery">Collection</NavLink>
                                <NavLink view="stats">Stats</NavLink>
                                <NavLink view="add">+ Add Album</NavLink>
                            </nav>
                            <div className="border-t border-gray-700 mt-4 pt-4 flex flex-col items-start space-y-3">
                                <span className="text-sm text-gray-400 w-full">{user.email}</span>
                                <button onClick={() => signOut(auth)} className="w-full text-left px-3 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">Logout</button>
                            </div>
                        </div>
                    )}
                </header>
            );
        }
        
        // --- Barcode Scanner Component ---
        function BarcodeScanner({ onScanSuccess, onCancel }) {
            useEffect(() => {
                const html5QrCode = new Html5Qrcode("reader");
        
                const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                    html5QrCode.stop()
                        .finally(() => {
                            onScanSuccess(decodedText);
                        });
                };
        
                const config = { fps: 10, qrbox: { width: 250, height: 150 } };
        
                html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback)
                    .catch(err => { 
                        console.error("Unable to start scanning.", err);
                        onCancel(); 
                    });
        
                return () => {
                    try {
                        if (html5QrCode && html5QrCode.isScanning) {
                            html5QrCode.stop();
                        }
                    } catch (err) {
                        console.error("Failed to stop scanner during cleanup.", err);
                    }
                };
            }, [onScanSuccess, onCancel]);
        
            return (
                <div className="flex flex-col items-center gap-4">
                    <p className="text-sm text-gray-400">Point your camera at the CD's barcode</p>
                    <div className="scanner-viewfinder">
                        <div id="reader"></div>
                        <div className="scanner-scan-line"></div>
                    </div>
                    <button
                        onClick={onCancel}
                        className="w-full max-w-xs px-4 py-2 font-bold bg-red-600 text-white rounded-md hover:bg-red-700"
                    >
                        Cancel Scan
                    </button>
                </div>
            );
        }

        // --- Add Single Album Component ---
        function AddAlbum({ onAlbumAdded, onCancel }) {
            const [barcode, setBarcode] = useState('');
            const [albumData, setAlbumData] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [isManualAdd, setIsManualAdd] = useState(false);
            const [isScanning, setIsScanning] = useState(false);
            const [manualFormData, setManualFormData] = useState({
                title: '', artist: '', coverUrl: '', releaseYear: new Date().getFullYear(), listened: false,
            });

            const handleBarcodeSearch = useCallback(async (searchBarcode) => {
                setLoading(true);
                setError('');
                setAlbumData(null);
                setIsManualAdd(false);

                if (!DISCOGS_TOKEN || DISCOGS_TOKEN === "PASTE_YOUR_TOKEN_HERE") {
                    setError("Discogs API token is missing. Please add it to the script.");
                    setLoading(false);
                    return;
                }

                try {
                    const sanitized = sanitizeBarcode(searchBarcode);
                    // --- Discogs API Call ---
                    const url = `https://api.discogs.com/database/search?barcode=${sanitized}`;
                    const response = await fetch(url, {
                        headers: {
                            'Authorization': `Discogs token=${DISCOGS_TOKEN}`,
                        },
                    });
                    const data = await response.json();

                    if (data.results && data.results.length > 0) {
                        const result = data.results[0];
                        const [artist, title] = result.title.split(' - ');
                        
                        setAlbumData({
                            title: title || result.title,
                            artist: artist || 'N/A',
                            releaseYear: result.year || 'N/A',
                            coverUrl: result.cover_image,
                            listened: false,
                        });
                    } else {
                        setError('Album not found for this barcode.');
                    }
                } catch (err) {
                    console.error("API Fetch Error:", err);
                    setError('Failed to fetch album data. Please check the barcode and your connection.');
                }
                setLoading(false);
            }, []);

            const handleScanSuccess = useCallback((decodedBarcode) => {
                setIsScanning(false);
                setBarcode(decodedBarcode);
                handleBarcodeSearch(decodedBarcode);
            }, [handleBarcodeSearch]);

            const handleBarcodeFormSubmit = (e) => {
                e.preventDefault();
                handleBarcodeSearch(barcode);
            };

            const handleAddAlbum = async (e) => {
                e.preventDefault();
                if (!albumData) return;
                
                const albumToSave = {
                    title: albumData.title,
                    artist: albumData.artist,
                    releaseYear: Number(albumData.releaseYear) || 0,
                    coverUrl: albumData.coverUrl,
                    barcode: sanitizeBarcode(barcode),
                    userId: auth.currentUser.uid,
                    listened: albumData.listened,
                };

                try {
                    await addDoc(collection(db, "albums"), albumToSave);
                    setBarcode('');
                    setAlbumData(null);
                    onAlbumAdded();
                } catch (err) {
                    console.error("Error adding album:", err);
                    setError('Failed to save album.');
                }
            };

            const handleSaveManualAlbum = async (e) => {
                e.preventDefault();
                if (!manualFormData.title || !manualFormData.artist) {
                    setError('Title and Artist are required.');
                    return;
                }
                
                const albumToSave = {
                    title: manualFormData.title,
                    artist: manualFormData.artist,
                    coverUrl: manualFormData.coverUrl || `https://placehold.co/250x250/1f2937/ffffff?text=${manualFormData.title.split(' ').join('+')}`,
                    userId: auth.currentUser.uid,
                    barcode: '', 
                    releaseYear: Number(manualFormData.releaseYear) || 0,
                    listened: manualFormData.listened,
                };

                try {
                    await addDoc(collection(db, "albums"), albumToSave);
                    setIsManualAdd(false);
                    setManualFormData({ title: '', artist: '', coverUrl: '', releaseYear: new Date().getFullYear(), listened: false });
                    onAlbumAdded();
                } catch (err) {
                    console.error("Error adding manual album:", err);
                    setError('Failed to save album.');
                }
            };
            
            const handleAlbumDataChange = (e) => {
                const { name, value, type, checked } = e.target;
                const val = type === 'checkbox' ? checked : value;
                setAlbumData(prev => ({ ...prev, [name]: val }));
            };

            const handleManualFormChange = (e) => {
                const { name, value, type, checked } = e.target;
                const val = type === 'checkbox' ? checked : value;
                setManualFormData(prev => ({ ...prev, [name]: val }));
            };

            const handleToggleManualAdd = () => {
                setIsManualAdd(true);
                setError('');
            };

            return (
                <div className="max-w-2xl mx-auto p-6 bg-gray-800 rounded-lg">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold">{isScanning ? 'Scan Album Barcode' : (isManualAdd ? 'Add Album Manually' : 'Add a New Album')}</h2>
                        <button onClick={isScanning ? () => setIsScanning(false) : onCancel} className="text-gray-400 hover:text-white">&times;</button>
                    </div>

                    {isScanning ? (
                        <BarcodeScanner onScanSuccess={handleScanSuccess} onCancel={() => setIsScanning(false)} />
                    ) : (
                        <>
                            {!isManualAdd && (
                                <div className="space-y-3 mb-4">
                                    <form onSubmit={handleBarcodeFormSubmit} className="flex gap-2">
                                        <input
                                            type="text"
                                            value={barcode}
                                            onChange={(e) => setBarcode(e.target.value)}
                                            placeholder="Enter barcode (UPC/EAN)"
                                            className="flex-grow p-2 bg-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                        />
                                        <button type="submit" disabled={loading} className="px-4 py-2 font-bold text-white bg-indigo-600 rounded-md hover:bg-indigo-700 disabled:bg-gray-500">
                                            {loading ? 'Searching...' : 'Find Album'}
                                        </button>
                                    </form>
                                    <button 
                                        onClick={() => setIsScanning(true)} 
                                        className="w-full py-2 font-bold text-white bg-gray-600 rounded-md hover:bg-gray-500 flex items-center justify-center gap-2"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /><path d="M3 8V4m0 12v4m18-4v4m0-12V4" /></svg>
                                        Scan Barcode
                                    </button>
                                </div>
                            )}

                            {error && <p className="text-red-400 mb-4">{error}</p>}

                            {error === 'Album not found for this barcode.' && !albumData && !isManualAdd && (
                                <div className="text-center">
                                    <button onClick={handleToggleManualAdd} className="px-4 py-2 font-bold text-white bg-green-600 rounded-md hover:bg-green-700">
                                        Add Manually
                                    </button>
                                </div>
                            )}

                            {isManualAdd && (
                                 <form onSubmit={handleSaveManualAlbum} className="space-y-4">
                                     <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                         <div>
                                             <label className="block text-sm font-medium text-gray-400">Title*</label>
                                             <input type="text" name="title" value={manualFormData.title} onChange={handleManualFormChange} className="w-full p-2 mt-1 bg-gray-700 rounded-md text-white" required/>
                                         </div>
                                         <div>
                                             <label className="block text-sm font-medium text-gray-400">Artist*</label>
                                             <input type="text" name="artist" value={manualFormData.artist} onChange={handleManualFormChange} className="w-full p-2 mt-1 bg-gray-700 rounded-md text-white" required/>
                                         </div>
                                     </div>
                                     <div>
                                         <label className="block text-sm font-medium text-gray-400">Cover Art URL</label>
                                         <input type="text" name="coverUrl" value={manualFormData.coverUrl} onChange={handleManualFormChange} className="w-full p-2 mt-1 bg-gray-700 rounded-md text-white"/>
                                     </div>
                                     <div>
                                         <label className="block text-sm font-medium text-gray-400">Release Year</label>
                                         <input type="number" name="releaseYear" value={manualFormData.releaseYear} onChange={handleManualFormChange} className="w-full p-2 mt-1 bg-gray-700 rounded-md text-white" />
                                     </div>
                                     <div className="flex items-center">
                                         <input type="checkbox" id="listenedManual" name="listened" checked={manualFormData.listened} onChange={handleManualFormChange} className="h-4 w-4 rounded bg-gray-600 border-gray-500 text-indigo-600 focus:ring-indigo-500"/>
                                         <label htmlFor="listenedManual" className="ml-2 block text-sm text-gray-300">I have listened to this album</label>
                                     </div>
                                     <button type="submit" className="w-full py-3 font-bold text-white bg-green-600 rounded-md hover:bg-green-700">Add Album</button>
                                  </form>
                            )}

                            {albumData && !isManualAdd && (
                                <form onSubmit={handleAddAlbum}>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 pt-4">
                                        <div className="md:col-span-1">
                                            <img src={albumData.coverUrl} alt={albumData.title} className="w-full h-auto object-cover rounded-md shadow-lg" onError={(e) => { e.target.onerror = null; e.target.src=`https://placehold.co/250x250/1f2937/ffffff?text=${albumData.title.split(' ').join('+')}`}}/>
                                        </div>
                                        <div className="md:col-span-2 space-y-4">
                                            <h3 className="text-2xl font-bold">{albumData.title}</h3>
                                            <p className="text-gray-400">by {albumData.artist}</p>
                                            
                                            <div>
                                                <label className="block text-sm font-medium text-gray-400">Release Year</label>
                                                <input type="number" name="releaseYear" value={albumData.releaseYear} onChange={handleAlbumDataChange} className="w-full p-2 mt-1 bg-gray-700 rounded-md text-white"/>
                                            </div>

                                            <div className="flex items-center">
                                                <input type="checkbox" id="listenedAPI" name="listened" checked={albumData.listened} onChange={handleAlbumDataChange} className="h-4 w-4 rounded bg-gray-600 border-gray-500 text-indigo-600 focus:ring-indigo-500"/>
                                                <label htmlFor="listenedAPI" className="ml-2 block text-sm text-gray-300">I have listened to this album</label>
                                            </div>
                                            <button type="submit" className="w-full py-3 font-bold text-white bg-green-600 rounded-md hover:bg-green-700">Add Album</button>
                                        </div>
                                    </div>
                                </form>
                            )}
                        </>
                    )}
                </div>
            );
        }
        
        // --- Decade Albums Modal Component ---
        function DecadeAlbumsModal({ isOpen, decade, albums, onClose }) {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="bg-gray-800 p-6 rounded-lg max-w-2xl w-full flex flex-col gap-4" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center">
                            <h2 className="text-2xl font-bold text-white">Albums from the {decade}</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
                        </div>
                        <div className="max-h-[60vh] overflow-y-auto space-y-3 pr-2">
                            {albums.length > 0 ? albums.map(album => (
                                <div key={album.id} className="flex items-start gap-4 p-3 bg-gray-700 rounded-lg">
                                    <img src={album.coverUrl} alt={album.title} className="w-12 h-12 object-cover rounded-md flex-shrink-0"/>
                                    <div>
                                        <p className="font-bold text-white">{album.title}</p>
                                        <p className="text-sm text-gray-300">{album.artist}</p>
                                        <p className="text-xs text-gray-500">Released in {album.releaseYear}</p>
                                    </div>
                                </div>
                            )) : (
                                <p className="text-gray-400">No albums found for this decade.</p>
                            )}
                        </div>
                        <button onClick={onClose} className="mt-2 ml-auto px-4 py-2 bg-indigo-600 text-white rounded-md">Close</button>
                    </div>
                </div>
            );
        }

       // --- Stats Component ---
        function Stats({ albums, loading }) {
            const [decadeModalData, setDecadeModalData] = useState({ isOpen: false, decade: '', albums: [] });
            
            const stats = useMemo(() => {
                if (albums.length === 0) return null;

                const artistCounts = albums.reduce((acc, album) => {
                    acc[album.artist] = (acc[album.artist] || 0) + 1;
                    return acc;
                }, {});
                
                const topArtists = Object.entries(artistCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);
                const uniqueArtists = new Set(albums.map(b => b.artist)).size;
                const listenedCount = albums.filter(a => a.listened).length;
                
                const albumsByDecade = albums.reduce((acc, album) => {
                    if (album.releaseYear && !isNaN(album.releaseYear)) {
                        const decade = Math.floor(album.releaseYear / 10) * 10;
                        acc[decade] = (acc[decade] || 0) + 1;
                    }
                    return acc;
                }, {});

                return {
                    total: albums.length, listenedCount,
                    topArtists, uniqueArtists, albumsByDecade
                };
            }, [albums]);

            useEffect(() => {
                let decadeChart, listenedChart;
                const chartInstances = [];

                if (stats) {
                    const decadeCtx = document.getElementById('decade-chart')?.getContext('2d');
                    if (decadeCtx) {
                        const sortedDecades = Object.keys(stats.albumsByDecade).sort();
                        decadeChart = new Chart(decadeCtx, {
                            type: 'bar',
                            data: {
                                labels: sortedDecades.map(d => `${d}s`),
                                datasets: [{ label: 'Albums by Decade', data: sortedDecades.map(d => stats.albumsByDecade[d]), backgroundColor: '#818cf8' }]
                            },
                            options: {
                                onClick: (event, elements, chart) => {
                                    if (elements.length > 0) {
                                        const elementIndex = elements[0].index;
                                        const clickedDecadeLabel = chart.data.labels[elementIndex];
                                        const clickedDecade = parseInt(clickedDecadeLabel);
                                        const albumsFromDecade = albums.filter(album => album.releaseYear && Math.floor(album.releaseYear / 10) * 10 === clickedDecade);
                                        
                                        setDecadeModalData({ isOpen: true, decade: clickedDecadeLabel, albums: albumsFromDecade });
                                    }
                                },
                                onHover: (event, chartElement) => { event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default'; },
                                scales: { y: { ticks: { color: 'white', stepSize: 1 }, grid: { color: '#4b5563' } }, x: { ticks: { color: 'white' } } }, 
                                plugins: { legend: { display: false }}
                            }
                        });
                        chartInstances.push(decadeChart);
                    }
                    
                    const listenedCtx = document.getElementById('listened-chart')?.getContext('2d');
                    if (listenedCtx) {
                        listenedChart = new Chart(listenedCtx, {
                            type: 'pie',
                            data: {
                                labels: ['Listened', 'Not Listened'],
                                datasets: [{ data: [stats.listenedCount, stats.total - stats.listenedCount], backgroundColor: ['#818cf8', '#4b5563'], borderColor: '#1f2937' }]
                            },
                            options: { plugins: { legend: { labels: { color: 'white' }}} }
                        });
                        chartInstances.push(listenedChart);
                    }
                }

                return () => { chartInstances.forEach(chart => { if (chart) chart.destroy(); }); };
            }, [stats, albums]);

            const handleCloseDecadeModal = () => setDecadeModalData({ isOpen: false, decade: '', albums: [] });

            if (loading) return <p>Loading stats...</p>;

            return (
                <div>
                    <DecadeAlbumsModal isOpen={decadeModalData.isOpen} decade={decadeModalData.decade} albums={decadeModalData.albums} onClose={handleCloseDecadeModal} />
                    <div className="flex items-center gap-4 mb-6">
                        <h2 className="text-2xl font-bold">Collection Statistics</h2>
                    </div>

                    {!stats ? (
                        <p className="text-gray-400">No albums in the collection yet. Add one to see your stats!</p>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div className="p-4 bg-gray-800 rounded-lg"><h3 className="font-bold text-lg mb-2">Total Albums</h3><p className="text-5xl font-bold text-indigo-400">{stats.total}</p></div>
                            <div className="p-4 bg-gray-800 rounded-lg"><h3 className="font-bold text-lg mb-2">Albums Listened To</h3><p className="text-5xl font-bold text-indigo-400">{stats.listenedCount}</p></div>
                            <div className="p-4 bg-gray-800 rounded-lg"><h3 className="font-bold text-lg mb-2">Unique Artists</h3><p className="text-5xl font-bold text-indigo-400">{stats.uniqueArtists}</p></div>
                            
                            <div className="md:col-span-2 lg:col-span-1 p-4 bg-gray-800 rounded-lg">
                                <h3 className="font-bold text-lg mb-4">Top Artists</h3>
                                <ol className="space-y-3">
                                    {stats.topArtists.map(([artist, count], index) => (
                                        <li key={artist} className="flex justify-between items-baseline text-sm">
                                            <span className="flex items-center truncate">
                                                <span className="text-gray-400 font-bold w-7 text-left">{index + 1}.</span>
                                                <span className="text-white truncate" title={artist}>{artist}</span>
                                            </span>
                                            <span className="font-mono text-indigo-400 flex-shrink-0 ml-2">{count} {count > 1 ? 'albums' : 'album'}</span>
                                        </li>
                                    ))}
                                </ol>
                            </div>

                            <div className="p-4 bg-gray-800 rounded-lg md:col-span-1 lg:col-span-2"><h3 className="font-bold text-lg mb-2">Listened vs. Unlistened</h3><canvas id="listened-chart"></canvas></div>
                            
                            <div className="p-4 bg-gray-800 rounded-lg md:col-span-2 lg:col-span-3"><h3 className="font-bold text-lg mb-2">Albums by Decade</h3><canvas id="decade-chart"></canvas></div>
                        </div>
                    )}
                </div>
            );
        }
        
       // --- Lightbox Component ---
        function Lightbox({ album, onClose, onToggleListened }) {
            if (!album) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="bg-gray-800 p-6 rounded-lg max-w-lg w-full flex flex-col md:flex-row gap-6" onClick={e => e.stopPropagation()}>
                        <img src={album.coverUrl} alt={album.title} className="w-48 h-auto object-cover rounded-md shadow-lg self-center md:self-start" />
                        <div className="flex flex-col flex-grow">
                            <h2 className="text-2xl font-bold text-white mb-2">{album.title}</h2>
                            <p className="text-lg text-gray-300 mb-4">{album.artist}</p>
                            <div className="space-y-2 text-sm mb-4">
                                <p><span className="font-bold text-gray-400">Released:</span> {album.releaseYear > 0 ? album.releaseYear : 'N/A'}</p>
                                <div className="flex items-center gap-2">
                                     <span className="font-bold text-gray-400">Status:</span>
                                     <span className={`px-2 py-0.5 rounded-full text-xs font-semibold ${album.listened ? 'bg-green-200 text-green-800' : 'bg-gray-600 text-gray-200'}`}>
                                        {album.listened ? 'Listened' : 'Not Listened'}
                                     </span>
                                </div>
                            </div>
                            
                            <button
                                onClick={() => onToggleListened(album.id, album.listened)}
                                className={`w-full mt-auto py-2 text-sm font-bold rounded-md transition-colors ${album.listened ? 'bg-yellow-500 hover:bg-yellow-600 text-gray-900' : 'bg-green-500 hover:bg-green-600 text-white'}`}
                            >
                                {album.listened ? 'Mark as Unlistened' : 'Mark as Listened'}
                            </button>

                            <button onClick={onClose} className="mt-2 w-full px-4 py-2 bg-indigo-600 text-white rounded-md text-sm">Close</button>
                        </div>
                    </div>
                </div>
            );
        }

        // --- Lightbox Component ---
        function Lightbox({ album, onClose, onToggleListened }) {
            if (!album) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="bg-gray-800 p-6 rounded-lg max-w-lg w-full flex flex-col md:flex-row gap-6" onClick={e => e.stopPropagation()}>
                        <img src={album.coverUrl} alt={album.title} className="w-48 h-auto object-cover rounded-md shadow-lg self-center md:self-start" />
                        <div className="flex flex-col flex-grow">
                            <h2 className="text-2xl font-bold text-white mb-2">{album.title}</h2>
                            <p className="text-lg text-gray-300 mb-4">{album.artist}</p>
                            <div className="space-y-2 text-sm mb-4">
                                <p><span className="font-bold text-gray-400">Released:</span> {album.releaseYear > 0 ? album.releaseYear : 'N/A'}</p>
                                <div className="flex items-center gap-2">
                                     <span className="font-bold text-gray-400">Status:</span>
                                     <span className={`px-2 py-0.5 rounded-full text-xs font-semibold ${album.listened ? 'bg-green-200 text-green-800' : 'bg-gray-600 text-gray-200'}`}>
                                        {album.listened ? 'Listened' : 'Not Listened'}
                                     </span>
                                </div>
                            </div>
                            
                            <button
                                onClick={() => onToggleListened(album.id, album.listened)}
                                className={`w-full mt-auto py-2 text-sm font-bold rounded-md transition-colors ${album.listened ? 'bg-yellow-500 hover:bg-yellow-600 text-gray-900' : 'bg-green-500 hover:bg-green-600 text-white'}`}
                            >
                                {album.listened ? 'Mark as Unlistened' : 'Mark as Listened'}
                            </button>

                            <button onClick={onClose} className="mt-2 w-full px-4 py-2 bg-indigo-600 text-white rounded-md text-sm">Close</button>
                        </div>
                    </div>
                </div>
            );
        }

       // --- Search Component ---
        function Search({ albums, onCancel }) {
            const [searchTerm, setSearchTerm] = useState('');
            const [searchType, setSearchType] = useState('title'); // 'title', 'artist', or 'barcode'
            const [results, setResults] = useState([]);
            const [hasSearched, setHasSearched] = useState(false);
            const [alertMessage, setAlertMessage] = useState('');
            const [isScanning, setIsScanning] = useState(false);

            const performSearch = (term, type) => {
                if (!term.trim()) return;

                setHasSearched(true);
                setResults([]);
                setAlertMessage('');
                setSearchTerm(term);
                setSearchType(type);

                if (type === 'barcode') {
                    const sanitized = sanitizeBarcode(term);
                    const foundAlbum = albums.find(album => album.barcode === sanitized);

                    if (foundAlbum) {
                        if (foundAlbum.listened) {
                            setAlertMessage(`You already own a copy of "${foundAlbum.title}," and you've listened to it before!`);
                        } else {
                            setAlertMessage(`You already own a copy of "${foundAlbum.title}," but it looks like it's still waiting for its first spin.`);
                        }
                    } else {
                        setAlertMessage("You dont own a copy of this yet!");
                    }
                } else {
                    const lowerCaseSearchTerm = term.toLowerCase();
                    const searchResults = albums.filter(album => {
                        return album[type].toLowerCase().includes(lowerCaseSearchTerm);
                    });
                    setResults(searchResults);
                }
            };

            const handleManualSearch = (e) => {
                e.preventDefault();
                performSearch(searchTerm, searchType);
            };

            const handleScanSuccess = (decodedBarcode) => {
                setIsScanning(false);
                performSearch(decodedBarcode, 'barcode');
            };

            return (
                <div className="max-w-4xl mx-auto p-6 bg-gray-800 rounded-lg">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold">{isScanning ? 'Scan Barcode' : 'Search Your Collection'}</h2>
                        {!isScanning && <button onClick={onCancel} className="text-gray-400 hover:text-white">&times;</button>}
                    </div>

                    {isScanning ? (
                        <BarcodeScanner onScanSuccess={handleScanSuccess} onCancel={() => setIsScanning(false)} />
                    ) : (
                        <>
                            <div className="mb-6">
                                <button
                                    onClick={() => setIsScanning(true)}
                                    className="w-full max-w-sm mx-auto px-4 py-3 font-bold bg-indigo-600 text-white rounded-md hover:bg-indigo-700 flex items-center justify-center gap-3 transition-transform transform hover:scale-105"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /><path d="M3 8V4m0 12v4m18-4v4m0-12V4" /></svg>
                                    Scan Barcode to Search
                                </button>
                            </div>

                            <div className="flex items-center my-6">
                                <hr className="flex-grow border-t border-gray-600" />
                                <span className="px-4 text-sm text-gray-400">Or search manually</span>
                                <hr className="flex-grow border-t border-gray-600" />
                            </div>

                            <form onSubmit={handleManualSearch} className="flex flex-col sm:flex-row gap-2 mb-6">
                                <input
                                    type="text"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    placeholder={`Search by ${searchType}...`}
                                    className="flex-grow p-2 bg-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                />
                                <select value={searchType} onChange={(e) => setSearchType(e.target.value)} className="p-2 bg-gray-700 rounded-md text-white">
                                    <option value="title">Title</option>
                                    <option value="artist">Artist</option>
                                    <option value="barcode">Barcode</option>
                                </select>
                                <button type="submit" className="px-4 py-2 font-bold text-white bg-gray-600 rounded-md hover:bg-gray-500">
                                    Search
                                </button>
                            </form>

                            <div className="mt-4">
                                {alertMessage && (
                                    <div className="text-center p-4 bg-gray-700 rounded-lg shadow-inner">
                                        <p className="text-lg text-indigo-300">{alertMessage}</p>
                                    </div>
                                )}

                                {!alertMessage && hasSearched && results.length > 0 && (
                                    <div className="space-y-3">
                                        {results.map(album => (
                                            <div key={album.id} className="flex items-start gap-4 p-3 bg-gray-700 rounded-lg">
                                                <img src={album.coverUrl} alt={album.title} className="w-10 h-10 object-cover rounded-md flex-shrink-0"/>
                                                <div>
                                                    <p className="font-bold text-white">{album.title}</p>
                                                    <p className="text-sm text-gray-400">{album.artist}</p>
                                                    <p className="text-xs text-gray-500">Released: {album.releaseYear}</p>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                                {!alertMessage && hasSearched && results.length === 0 && (
                                    <p className="text-center text-gray-400">No albums found matching your search.</p>
                                )}
                            </div>
                        </>
                    )}
                </div>
            );
        }

        // Render the app
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>
